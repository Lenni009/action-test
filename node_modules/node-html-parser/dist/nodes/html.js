"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=exports.base_parse=void 0;var css_select_1=require("css-select"),he_1=__importDefault(require("he")),back_1=__importDefault(require("../back")),matcher_1=__importDefault(require("../matcher")),void_tag_1=__importDefault(require("../void-tag")),comment_1=__importDefault(require("./comment")),node_1=__importDefault(require("./node")),text_1=__importDefault(require("./text")),type_1=__importDefault(require("./type"));function decode(e){return JSON.parse(JSON.stringify(he_1.default.decode(e)))}var Htags=["h1","h2","h3","h4","h5","h6","header","hgroup"],Dtags=["details","dialog","dd","div","dt"],Ftags=["fieldset","figcaption","figure","footer","form"],tableTags=["table","td","tr"],htmlTags=["address","article","aside","blockquote","br","hr","li","main","nav","ol","p","pre","section","ul"],kBlockElements=new Set;function addToKBlockElement(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var r=function(e){for(var t=0;t<e.length;t++){var r=e[t];kBlockElements.add(r),kBlockElements.add(r.toUpperCase())}},n=0,i=e;n<i.length;n++){r(i[n])}}addToKBlockElement(Htags,Dtags,Ftags,tableTags,htmlTags);var DOMTokenList=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=function(){return null}),this._set=new Set(e),this._afterUpdate=t}return e.prototype._validate=function(e){if(/\s/.test(e))throw new Error("DOMException in DOMTokenList.add: The token '".concat(e,"' contains HTML space characters, which are not valid in tokens."))},e.prototype.add=function(e){this._validate(e),this._set.add(e),this._afterUpdate(this)},e.prototype.replace=function(e,t){this._validate(t),this._set.delete(e),this._set.add(t),this._afterUpdate(this)},e.prototype.remove=function(e){this._set.delete(e)&&this._afterUpdate(this)},e.prototype.toggle=function(e){this._validate(e),this._set.has(e)?this._set.delete(e):this._set.add(e),this._afterUpdate(this)},e.prototype.contains=function(e){return this._set.has(e)},Object.defineProperty(e.prototype,"length",{get:function(){return this._set.size},enumerable:!1,configurable:!0}),e.prototype.values=function(){return this._set.values()},Object.defineProperty(e.prototype,"value",{get:function(){return Array.from(this._set.values())},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return Array.from(this._set.values()).join(" ")},e}(),HTMLElement=function(e){function t(t,r,n,i,o,a,s){void 0===n&&(n=""),void 0===a&&(a=new void_tag_1.default),void 0===s&&(s={});var l=e.call(this,i,o)||this;if(l.rawAttrs=n,l.voidTag=a,l.nodeType=type_1.default.ELEMENT_NODE,l.rawTagName=t,l.rawAttrs=n||"",l.id=r.id||"",l.childNodes=[],l._parseOptions=s,l.classList=new DOMTokenList(r.class?r.class.split(/\s+/):[],(function(e){return l.setAttribute("class",e.toString())})),r.id&&(n||(l.rawAttrs='id="'.concat(r.id,'"'))),r.class&&!n){var d='class="'.concat(l.classList.toString(),'"');l.rawAttrs?l.rawAttrs+=" ".concat(d):l.rawAttrs=d}return l}return __extends(t,e),t.prototype.quoteAttribute=function(e){return null==e?"null":JSON.stringify(e.replace(/"/g,"&quot;"))},t.prototype.removeChild=function(e){return this.childNodes=this.childNodes.filter((function(t){return t!==e})),this},t.prototype.exchangeChild=function(e,t){var r=this.childNodes;return this.childNodes=r.map((function(r){return r===e?t:r})),this},Object.defineProperty(t.prototype,"tagName",{get:function(){return this.rawTagName?this.rawTagName.toUpperCase():this.rawTagName},set:function(e){this.rawTagName=e.toLowerCase()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"localName",{get:function(){return this.rawTagName.toLowerCase()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVoidElement",{get:function(){return this.voidTag.isVoidElement(this.localName)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rawText",{get:function(){return this.childNodes.reduce((function(e,t){return e+t.rawText}),"")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textContent",{get:function(){return decode(this.rawText)},set:function(e){var t=[new text_1.default(e,this)];this.childNodes=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"text",{get:function(){return decode(this.rawText)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"structuredText",{get:function(){var e=[],t=[e];return function r(n){if(n.nodeType===type_1.default.ELEMENT_NODE)kBlockElements.has(n.rawTagName)?(e.length>0&&t.push(e=[]),n.childNodes.forEach(r),e.length>0&&t.push(e=[])):n.childNodes.forEach(r);else if(n.nodeType===type_1.default.TEXT_NODE)if(n.isWhitespace)e.prependWhitespace=!0;else{var i=n.trimmedText;e.prependWhitespace&&(i=" ".concat(i),e.prependWhitespace=!1),e.push(i)}}(this),t.map((function(e){return e.join("").replace(/\s{2,}/g," ")})).join("\n").replace(/\s+$/,"")},enumerable:!1,configurable:!0}),t.prototype.toString=function(){var e=this.rawTagName;if(e){var t=this.rawAttrs?" ".concat(this.rawAttrs):"";return this.voidTag.formatNode(e,t,this.innerHTML)}return this.innerHTML},Object.defineProperty(t.prototype,"innerHTML",{get:function(){return this.childNodes.map((function(e){return e.toString()})).join("")},set:function(e){var t=parse(e,this._parseOptions),r=t.childNodes.length?t.childNodes:[new text_1.default(e,this)];resetParent(r,this),resetParent(this.childNodes,null),this.childNodes=r},enumerable:!1,configurable:!0}),t.prototype.set_content=function(e,t){if(void 0===t&&(t={}),e instanceof node_1.default)e=[e];else if("string"==typeof e){var r=parse(e,t=__assign(__assign({},this._parseOptions),t));e=r.childNodes.length?r.childNodes:[new text_1.default(r.innerHTML,this)]}return resetParent(this.childNodes,null),resetParent(e,this),this.childNodes=e,this},t.prototype.replaceWith=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=this.parentNode,i=t.map((function(t){if(t instanceof node_1.default)return[t];if("string"==typeof t){var r=parse(t,e._parseOptions);return r.childNodes.length?r.childNodes:[new text_1.default(t,e)]}return[]})).flat(),o=n.childNodes.findIndex((function(t){return t===e}));return resetParent([this],null),n.childNodes=__spreadArray(__spreadArray(__spreadArray([],n.childNodes.slice(0,o),!0),resetParent(i,n),!0),n.childNodes.slice(o+1),!0),this},Object.defineProperty(t.prototype,"outerHTML",{get:function(){return this.toString()},enumerable:!1,configurable:!0}),t.prototype.trimRight=function(e){for(var t=0;t<this.childNodes.length;t++){var r=this.childNodes[t];if(r.nodeType===type_1.default.ELEMENT_NODE)r.trimRight(e);else{var n=r.rawText.search(e);n>-1&&(r.rawText=r.rawText.substr(0,n),this.childNodes.length=t+1)}}return this},Object.defineProperty(t.prototype,"structure",{get:function(){var e=[],t=0;function r(r){e.push("  ".repeat(t)+r)}return function e(n){var i=n.id?"#".concat(n.id):"",o=n.classList.length?".".concat(n.classList.value.join(".")):"";r("".concat(n.rawTagName).concat(i).concat(o)),t++,n.childNodes.forEach((function(t){t.nodeType===type_1.default.ELEMENT_NODE?e(t):t.nodeType===type_1.default.TEXT_NODE&&(t.isWhitespace||r("#text"))})),t--}(this),e.join("\n")},enumerable:!1,configurable:!0}),t.prototype.removeWhitespace=function(){var e=this,t=0;return this.childNodes.forEach((function(r){if(r.nodeType===type_1.default.TEXT_NODE){if(r.isWhitespace)return;r.rawText=r.trimmedRawText}else r.nodeType===type_1.default.ELEMENT_NODE&&r.removeWhitespace();e.childNodes[t++]=r})),this.childNodes.length=t,this},t.prototype.querySelectorAll=function(e){return(0,css_select_1.selectAll)(e,this,{xmlMode:!0,adapter:matcher_1.default})},t.prototype.querySelector=function(e){return(0,css_select_1.selectOne)(e,this,{xmlMode:!0,adapter:matcher_1.default})},t.prototype.getElementsByTagName=function(e){for(var t=e.toUpperCase(),r=[],n=[],i=this,o=0;void 0!==o;){var a=void 0;do{a=i.childNodes[o++]}while(o<i.childNodes.length&&void 0===a);void 0!==a?a.nodeType===type_1.default.ELEMENT_NODE&&("*"!==e&&a.tagName!==t||r.push(a),a.childNodes.length>0&&(n.push(o),i=a,o=0)):(i=i.parentNode,o=n.pop())}return r},t.prototype.getElementById=function(e){for(var t=[],r=this,n=0;void 0!==n;){var i=void 0;do{i=r.childNodes[n++]}while(n<r.childNodes.length&&void 0===i);if(void 0!==i){if(i.nodeType===type_1.default.ELEMENT_NODE){if(i.id===e)return i;i.childNodes.length>0&&(t.push(n),r=i,n=0)}}else r=r.parentNode,n=t.pop()}return null},t.prototype.closest=function(e){var t=new Map,r=this,n=null;function i(e,r){for(var n=null,o=0,a=r.length;o<a&&!n;o++){var s=r[o];if(e(s))n=s;else{var l=t.get(s);l&&(n=i(e,[l]))}}return n}for(;r;)t.set(r,n),n=r,r=r.parentNode;for(r=this;r;){var o=(0,css_select_1.selectOne)(e,r,{xmlMode:!0,adapter:__assign(__assign({},matcher_1.default),{getChildren:function(e){var r=t.get(e);return r&&[r]},getSiblings:function(e){return[e]},findOne:i,findAll:function(){return[]}})});if(o)return o;r=r.parentNode}return null},t.prototype.appendChild=function(e){return e.remove(),this.childNodes.push(e),e.parentNode=this,e},Object.defineProperty(t.prototype,"firstChild",{get:function(){return this.childNodes[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lastChild",{get:function(){return(0,back_1.default)(this.childNodes)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attrs",{get:function(){if(this._attrs)return this._attrs;this._attrs={};var e=this.rawAttributes;for(var t in e){var r=e[t]||"";this._attrs[t.toLowerCase()]=decode(r)}return this._attrs},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attributes",{get:function(){var e={},t=this.rawAttributes;for(var r in t){var n=t[r]||"";e[r]=decode(n)}return e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rawAttributes",{get:function(){if(this._rawAttrs)return this._rawAttrs;var e={};if(this.rawAttrs)for(var t=/([a-zA-Z()[\]#@$.?:][a-zA-Z0-9-_:()[\]#]*)(?:\s*=\s*((?:'[^']*')|(?:"[^"]*")|\S+))?/g,r=void 0;r=t.exec(this.rawAttrs);){var n=r[1],i=r[2]||null;!i||"'"!==i[0]&&'"'!==i[0]||(i=i.slice(1,i.length-1)),e[n]=e[n]||i}return this._rawAttrs=e,e},enumerable:!1,configurable:!0}),t.prototype.removeAttribute=function(e){var t=this.rawAttributes;return delete t[e],this._attrs&&delete this._attrs[e],this.rawAttrs=Object.keys(t).map((function(e){var r=JSON.stringify(t[e]);return void 0===r||"null"===r?e:"".concat(e,"=").concat(r)})).join(" "),"id"===e&&(this.id=""),this},t.prototype.hasAttribute=function(e){return e.toLowerCase()in this.attrs},t.prototype.getAttribute=function(e){return this.attrs[e.toLowerCase()]},t.prototype.setAttribute=function(e,t){var r=this;if(arguments.length<2)throw new Error("Failed to execute 'setAttribute' on 'Element'");var n=e.toLowerCase(),i=this.rawAttributes;for(var o in i)if(o.toLowerCase()===n){e=o;break}return i[e]=String(t),this._attrs&&(this._attrs[n]=decode(i[e])),this.rawAttrs=Object.keys(i).map((function(e){var t=r.quoteAttribute(i[e]);return"null"===t||'""'===t?e:"".concat(e,"=").concat(t)})).join(" "),"id"===e&&(this.id=t),this},t.prototype.setAttributes=function(e){var t=this;return this._attrs&&delete this._attrs,this._rawAttrs&&delete this._rawAttrs,this.rawAttrs=Object.keys(e).map((function(r){var n=e[r];return"null"===n||'""'===n?r:"".concat(r,"=").concat(t.quoteAttribute(String(n)))})).join(" "),this},t.prototype.insertAdjacentHTML=function(e,t){var r,n,i,o=this;if(arguments.length<2)throw new Error("2 arguments required");var a=parse(t,this._parseOptions);if("afterend"===e){var s=this.parentNode.childNodes.findIndex((function(e){return e===o}));resetParent(a.childNodes,this.parentNode),(r=this.parentNode.childNodes).splice.apply(r,__spreadArray([s+1,0],a.childNodes,!1))}else if("afterbegin"===e)resetParent(a.childNodes,this),(n=this.childNodes).unshift.apply(n,a.childNodes);else if("beforeend"===e)a.childNodes.forEach((function(e){o.appendChild(e)}));else{if("beforebegin"!==e)throw new Error("The value provided ('".concat(e,"') is not one of 'beforebegin', 'afterbegin', 'beforeend', or 'afterend'"));s=this.parentNode.childNodes.findIndex((function(e){return e===o}));resetParent(a.childNodes,this.parentNode),(i=this.parentNode.childNodes).splice.apply(i,__spreadArray([s,0],a.childNodes,!1))}return this},Object.defineProperty(t.prototype,"nextSibling",{get:function(){if(this.parentNode){for(var e=this.parentNode.childNodes,t=0;t<e.length;){if(this===e[t++])return e[t]||null}return null}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nextElementSibling",{get:function(){if(this.parentNode){for(var e=this.parentNode.childNodes,r=0,n=!1;r<e.length;){var i=e[r++];if(n){if(i instanceof t)return i||null}else this===i&&(n=!0)}return null}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"previousSibling",{get:function(){if(this.parentNode){for(var e=this.parentNode.childNodes,t=e.length;t>0;){if(this===e[--t])return e[t-1]||null}return null}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"previousElementSibling",{get:function(){if(this.parentNode){for(var e=this.parentNode.childNodes,r=e.length,n=!1;r>0;){var i=e[--r];if(n){if(i instanceof t)return i||null}else this===i&&(n=!0)}return null}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"classNames",{get:function(){return this.classList.toString()},enumerable:!1,configurable:!0}),t.prototype.clone=function(){return parse(this.toString(),this._parseOptions).firstChild},t}(node_1.default);exports.default=HTMLElement;var kMarkupPattern=/<!--[\s\S]*?-->|<(\/?)([a-zA-Z][-.:0-9_a-zA-Z]*)((?:\s+[^>]*?(?:(?:'[^']*')|(?:"[^"]*"))?)*)\s*(\/?)>/g,kAttributePattern=/(?:^|\s)(id|class)\s*=\s*((?:'[^']*')|(?:"[^"]*")|\S+)/gi,kSelfClosingElements={area:!0,AREA:!0,base:!0,BASE:!0,br:!0,BR:!0,col:!0,COL:!0,hr:!0,HR:!0,img:!0,IMG:!0,input:!0,INPUT:!0,link:!0,LINK:!0,meta:!0,META:!0,source:!0,SOURCE:!0,embed:!0,EMBED:!0,param:!0,PARAM:!0,track:!0,TRACK:!0,wbr:!0,WBR:!0},kElementsClosedByOpening={li:{li:!0,LI:!0},LI:{li:!0,LI:!0},p:{p:!0,div:!0,P:!0,DIV:!0},P:{p:!0,div:!0,P:!0,DIV:!0},b:{div:!0,DIV:!0},B:{div:!0,DIV:!0},td:{td:!0,th:!0,TD:!0,TH:!0},TD:{td:!0,th:!0,TD:!0,TH:!0},th:{td:!0,th:!0,TD:!0,TH:!0},TH:{td:!0,th:!0,TD:!0,TH:!0},h1:{h1:!0,H1:!0},H1:{h1:!0,H1:!0},h2:{h2:!0,H2:!0},H2:{h2:!0,H2:!0},h3:{h3:!0,H3:!0},H3:{h3:!0,H3:!0},h4:{h4:!0,H4:!0},H4:{h4:!0,H4:!0},h5:{h5:!0,H5:!0},H5:{h5:!0,H5:!0},h6:{h6:!0,H6:!0},H6:{h6:!0,H6:!0}},kElementsClosedByClosing={li:{ul:!0,ol:!0,UL:!0,OL:!0},LI:{ul:!0,ol:!0,UL:!0,OL:!0},a:{div:!0,DIV:!0},A:{div:!0,DIV:!0},b:{div:!0,DIV:!0},B:{div:!0,DIV:!0},i:{div:!0,DIV:!0},I:{div:!0,DIV:!0},p:{div:!0,DIV:!0},P:{div:!0,DIV:!0},td:{tr:!0,table:!0,TR:!0,TABLE:!0},TD:{tr:!0,table:!0,TR:!0,TABLE:!0},th:{tr:!0,table:!0,TR:!0,TABLE:!0},TH:{tr:!0,table:!0,TR:!0,TABLE:!0}},frameflag="documentfragmentcontainer";function base_parse(e,t){var r,n;void 0===t&&(t={});var i=new void_tag_1.default(null===(r=null==t?void 0:t.voidTag)||void 0===r?void 0:r.closingSlash,null===(n=null==t?void 0:t.voidTag)||void 0===n?void 0:n.tags),o=t.blockTextElements||{script:!0,noscript:!0,style:!0,pre:!0},a=Object.keys(o),s=a.map((function(e){return new RegExp("^".concat(e,"$"),"i")})),l=a.filter((function(e){return o[e]})).map((function(e){return new RegExp("^".concat(e,"$"),"i")}));function d(e){return l.some((function(t){return t.test(e)}))}function u(e){return s.some((function(t){return t.test(e)}))}var c,p=function(e,t){return[e-N,t-N]},h=new HTMLElement(null,{},"",null,[0,e.length],i,t),f=h,g=[h],_=-1,v=void 0;e="<".concat(frameflag,">").concat(e,"</").concat(frameflag,">");for(var y=t.lowerCaseTagName,b=t.fixNestedATags,m=e.length-(frameflag.length+2),N=frameflag.length+2;c=kMarkupPattern.exec(e);){var T=c[0],w=c[1],E=c[2],O=c[3],A=c[4],k=T.length,x=kMarkupPattern.lastIndex-k,P=kMarkupPattern.lastIndex;if(_>-1&&_+k<P){var L=e.substring(_,x);f.appendChild(new text_1.default(L,f,p(_,x)))}if(_=kMarkupPattern.lastIndex,E!==frameflag)if("!"!==T[1]){if(y&&(E=E.toLowerCase()),!w){for(var C={},D=void 0;D=kAttributePattern.exec(O);){var M=D[1],j=D[2],H="'"===j[0]||'"'===j[0];C[M.toLowerCase()]=H?j.slice(1,j.length-1):j}var S=f.rawTagName;!A&&kElementsClosedByOpening[S]&&kElementsClosedByOpening[S][E]&&(g.pop(),f=(0,back_1.default)(g)),!b||"a"!==E&&"A"!==E||(void 0!==v&&(g.splice(v),f=(0,back_1.default)(g)),v=g.length);var I=kMarkupPattern.lastIndex,B=I-k;if(f=f.appendChild(new HTMLElement(E,C,O.slice(1),null,p(B,I),i,t)),g.push(f),u(E)){var q="</".concat(E,">"),R=y?e.toLocaleLowerCase().indexOf(q,kMarkupPattern.lastIndex):e.indexOf(q,kMarkupPattern.lastIndex),V=-1===R?m:R;if(d(E))(L=e.substring(I,V)).length>0&&/\S/.test(L)&&f.appendChild(new text_1.default(L,f,p(I,V)));-1===R?_=kMarkupPattern.lastIndex=e.length+1:(_=kMarkupPattern.lastIndex=R+q.length,w="/")}}if(w||A||kSelfClosingElements[E])for(;;){if(null==v||"a"!==E&&"A"!==E||(v=void 0),f.rawTagName===E){f.range[1]=p(-1,Math.max(_,P))[1],g.pop(),f=(0,back_1.default)(g);break}S=f.tagName;if(!kElementsClosedByClosing[S]||!kElementsClosedByClosing[S][E])break;g.pop(),f=(0,back_1.default)(g)}}else if(t.comment){var L=e.substring(x+4,P-3);f.appendChild(new comment_1.default(L,f,p(x,P)))}}return g}function parse(e,t){void 0===t&&(t={});for(var r=base_parse(e,t),n=r[0],i=function(){var e=r.pop(),n=(0,back_1.default)(r);e.parentNode&&e.parentNode.parentNode&&(e.parentNode===n&&e.tagName===n.tagName?!0!==t.parseNoneClosedTags&&(n.removeChild(e),e.childNodes.forEach((function(e){n.parentNode.appendChild(e)})),r.pop()):!0!==t.parseNoneClosedTags&&(n.removeChild(e),e.childNodes.forEach((function(e){n.appendChild(e)}))))};r.length>1;)i();return n}function resetParent(e,t){return e.map((function(e){return e.parentNode=t,e}))}exports.base_parse=base_parse,exports.parse=parse;
