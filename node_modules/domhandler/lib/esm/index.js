import{ElementType}from"domelementtype";import{Element,Text,Comment,CDATA,Document,ProcessingInstruction}from"./node.js";export*from"./node.js";const defaultOpts={withStartIndices:!1,withEndIndices:!1,xmlMode:!1};export class DomHandler{constructor(t,e,n){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null,"function"==typeof e&&(n=e,e=defaultOpts),"object"==typeof t&&(e=t,t=void 0),this.callback=null!=t?t:null,this.options=null!=e?e:defaultOpts,this.elementCB=null!=n?n:null}onparserinit(t){this.parser=t}onreset(){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null}onend(){this.done||(this.done=!0,this.parser=null,this.handleCallback(null))}onerror(t){this.handleCallback(t)}onclosetag(){this.lastNode=null;const t=this.tagStack.pop();this.options.withEndIndices&&(t.endIndex=this.parser.endIndex),this.elementCB&&this.elementCB(t)}onopentag(t,e){const n=this.options.xmlMode?ElementType.Tag:void 0,s=new Element(t,e,void 0,n);this.addNode(s),this.tagStack.push(s)}ontext(t){const{lastNode:e}=this;if(e&&e.type===ElementType.Text)e.data+=t,this.options.withEndIndices&&(e.endIndex=this.parser.endIndex);else{const e=new Text(t);this.addNode(e),this.lastNode=e}}oncomment(t){if(this.lastNode&&this.lastNode.type===ElementType.Comment)return void(this.lastNode.data+=t);const e=new Comment(t);this.addNode(e),this.lastNode=e}oncommentend(){this.lastNode=null}oncdatastart(){const t=new Text(""),e=new CDATA([t]);this.addNode(e),t.parent=e,this.lastNode=t}oncdataend(){this.lastNode=null}onprocessinginstruction(t,e){const n=new ProcessingInstruction(t,e);this.addNode(n)}handleCallback(t){if("function"==typeof this.callback)this.callback(t,this.dom);else if(t)throw t}addNode(t){const e=this.tagStack[this.tagStack.length-1],n=e.children[e.children.length-1];this.options.withStartIndices&&(t.startIndex=this.parser.startIndex),this.options.withEndIndices&&(t.endIndex=this.parser.endIndex),e.children.push(t),n&&(t.prev=n,n.next=t),t.parent=e,this.lastNode=null}}export default DomHandler;
