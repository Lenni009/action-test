import{SelectorType,AttributeAction}from"./types";const reName=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,reEscape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,actionTypes=new Map([[126,AttributeAction.Element],[94,AttributeAction.Start],[36,AttributeAction.End],[42,AttributeAction.Any],[33,AttributeAction.Not],[124,AttributeAction.Hyphen]]),unpackPseudos=new Set(["has","not","matches","is","where","host","host-context"]);export function isTraversal(e){switch(e.type){case SelectorType.Adjacent:case SelectorType.Child:case SelectorType.Descendant:case SelectorType.Parent:case SelectorType.Sibling:case SelectorType.ColumnCombinator:return!0;default:return!1}}const stripQuotesFromPseudos=new Set(["contains","icontains"]);function funescape(e,t,r){const n=parseInt(t,16)-65536;return n!=n||r?t:n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320)}function unescapeCSS(e){return e.replace(reEscape,funescape)}function isQuote(e){return 39===e||34===e}function isWhitespace(e){return 32===e||9===e||10===e||12===e||13===e}export function parse(e){const t=[],r=parseSelector(t,`${e}`,0);if(r<e.length)throw new Error(`Unmatched selector: ${e.slice(r)}`);return t}function parseSelector(e,t,r){let n=[];function o(e){const n=t.slice(r+e).match(reName);if(!n)throw new Error(`Expected name, found ${t.slice(r)}`);const[o]=n;return r+=e+o.length,unescapeCSS(o)}function c(e){for(r+=e;r<t.length&&isWhitespace(t.charCodeAt(r));)r++}function s(){const e=r+=1;let n=1;for(;n>0&&r<t.length;r++)40!==t.charCodeAt(r)||a(r)?41!==t.charCodeAt(r)||a(r)||n--:n++;if(n)throw new Error("Parenthesis not matched");return unescapeCSS(t.slice(e,r-1))}function a(e){let r=0;for(;92===t.charCodeAt(--e);)r++;return 1==(1&r)}function i(){if(n.length>0&&isTraversal(n[n.length-1]))throw new Error("Did not expect successive traversals.")}function l(e){n.length>0&&n[n.length-1].type===SelectorType.Descendant?n[n.length-1].type=e:(i(),n.push({type:e}))}function u(e,t){n.push({type:SelectorType.Attribute,name:e,action:t,value:o(1),namespace:null,ignoreCase:"quirks"})}function h(){if(n.length&&n[n.length-1].type===SelectorType.Descendant&&n.pop(),0===n.length)throw new Error("Empty sub-selector");e.push(n)}if(c(0),t.length===r)return r;e:for(;r<t.length;){const e=t.charCodeAt(r);switch(e){case 32:case 9:case 10:case 12:case 13:0!==n.length&&n[0].type===SelectorType.Descendant||(i(),n.push({type:SelectorType.Descendant})),c(1);break;case 62:l(SelectorType.Child),c(1);break;case 60:l(SelectorType.Parent),c(1);break;case 126:l(SelectorType.Sibling),c(1);break;case 43:l(SelectorType.Adjacent),c(1);break;case 46:u("class",AttributeAction.Element);break;case 35:u("id",AttributeAction.Equals);break;case 91:{let e;c(1);let s=null;124===t.charCodeAt(r)?e=o(1):t.startsWith("*|",r)?(s="*",e=o(2)):(e=o(0),124===t.charCodeAt(r)&&61!==t.charCodeAt(r+1)&&(s=e,e=o(1))),c(0);let i=AttributeAction.Exists;const l=actionTypes.get(t.charCodeAt(r));if(l){if(i=l,61!==t.charCodeAt(r+1))throw new Error("Expected `=`");c(2)}else 61===t.charCodeAt(r)&&(i=AttributeAction.Equals,c(1));let u="",h=null;if("exists"!==i){if(isQuote(t.charCodeAt(r))){const e=t.charCodeAt(r);let n=r+1;for(;n<t.length&&(t.charCodeAt(n)!==e||a(n));)n+=1;if(t.charCodeAt(n)!==e)throw new Error("Attribute value didn't end");u=unescapeCSS(t.slice(r+1,n)),r=n+1}else{const e=r;for(;r<t.length&&(!isWhitespace(t.charCodeAt(r))&&93!==t.charCodeAt(r)||a(r));)r+=1;u=unescapeCSS(t.slice(e,r))}c(0);const e=32|t.charCodeAt(r);115===e?(h=!1,c(1)):105===e&&(h=!0,c(1))}if(93!==t.charCodeAt(r))throw new Error("Attribute selector didn't terminate");r+=1;const p={type:SelectorType.Attribute,name:e,action:i,value:u,namespace:s,ignoreCase:h};n.push(p);break}case 58:{if(58===t.charCodeAt(r+1)){n.push({type:SelectorType.PseudoElement,name:o(2).toLowerCase(),data:40===t.charCodeAt(r)?s():null});continue}const e=o(1).toLowerCase();let c=null;if(40===t.charCodeAt(r))if(unpackPseudos.has(e)){if(isQuote(t.charCodeAt(r+1)))throw new Error(`Pseudo-selector ${e} cannot be quoted`);if(c=[],r=parseSelector(c,t,r+1),41!==t.charCodeAt(r))throw new Error(`Missing closing parenthesis in :${e} (${t})`);r+=1}else{if(c=s(),stripQuotesFromPseudos.has(e)){const e=c.charCodeAt(0);e===c.charCodeAt(c.length-1)&&isQuote(e)&&(c=c.slice(1,-1))}c=unescapeCSS(c)}n.push({type:SelectorType.Pseudo,name:e,data:c});break}case 44:h(),n=[],c(1);break;default:{if(t.startsWith("/*",r)){const e=t.indexOf("*/",r+2);if(e<0)throw new Error("Comment was not terminated");r=e+2,0===n.length&&c(0);break}let s,a=null;if(42===e)r+=1,s="*";else if(124===e){if(s="",124===t.charCodeAt(r+1)){l(SelectorType.ColumnCombinator),c(2);break}}else{if(!reName.test(t.slice(r)))break e;s=o(0)}124===t.charCodeAt(r)&&124!==t.charCodeAt(r+1)&&(a=s,42===t.charCodeAt(r+1)?(s="*",r+=2):s=o(1)),n.push("*"===s?{type:SelectorType.Universal,namespace:a}:{type:SelectorType.Tag,name:s,namespace:a})}}}return h(),r}
