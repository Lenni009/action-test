"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=exports.isTraversal=void 0;var types_1=require("./types"),reName=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,reEscape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,actionTypes=new Map([[126,types_1.AttributeAction.Element],[94,types_1.AttributeAction.Start],[36,types_1.AttributeAction.End],[42,types_1.AttributeAction.Any],[33,types_1.AttributeAction.Not],[124,types_1.AttributeAction.Hyphen]]),unpackPseudos=new Set(["has","not","matches","is","where","host","host-context"]);function isTraversal(e){switch(e.type){case types_1.SelectorType.Adjacent:case types_1.SelectorType.Child:case types_1.SelectorType.Descendant:case types_1.SelectorType.Parent:case types_1.SelectorType.Sibling:case types_1.SelectorType.ColumnCombinator:return!0;default:return!1}}exports.isTraversal=isTraversal;var stripQuotesFromPseudos=new Set(["contains","icontains"]);function funescape(e,t,r){var a=parseInt(t,16)-65536;return a!=a||r?t:a<0?String.fromCharCode(a+65536):String.fromCharCode(a>>10|55296,1023&a|56320)}function unescapeCSS(e){return e.replace(reEscape,funescape)}function isQuote(e){return 39===e||34===e}function isWhitespace(e){return 32===e||9===e||10===e||12===e||13===e}function parse(e){var t=[],r=parseSelector(t,"".concat(e),0);if(r<e.length)throw new Error("Unmatched selector: ".concat(e.slice(r)));return t}function parseSelector(e,t,r){var a=[];function s(e){var a=t.slice(r+e).match(reName);if(!a)throw new Error("Expected name, found ".concat(t.slice(r)));var s=a[0];return r+=e+s.length,unescapeCSS(s)}function n(e){for(r+=e;r<t.length&&isWhitespace(t.charCodeAt(r));)r++}function o(){for(var e=r+=1,a=1;a>0&&r<t.length;r++)40!==t.charCodeAt(r)||c(r)?41!==t.charCodeAt(r)||c(r)||a--:a++;if(a)throw new Error("Parenthesis not matched");return unescapeCSS(t.slice(e,r-1))}function c(e){for(var r=0;92===t.charCodeAt(--e);)r++;return 1==(1&r)}function i(){if(a.length>0&&isTraversal(a[a.length-1]))throw new Error("Did not expect successive traversals.")}function p(e){a.length>0&&a[a.length-1].type===types_1.SelectorType.Descendant?a[a.length-1].type=e:(i(),a.push({type:e}))}function l(e,t){a.push({type:types_1.SelectorType.Attribute,name:e,action:t,value:s(1),namespace:null,ignoreCase:"quirks"})}function u(){if(a.length&&a[a.length-1].type===types_1.SelectorType.Descendant&&a.pop(),0===a.length)throw new Error("Empty sub-selector");e.push(a)}if(n(0),t.length===r)return r;e:for(;r<t.length;){var h=t.charCodeAt(r);switch(h){case 32:case 9:case 10:case 12:case 13:0!==a.length&&a[0].type===types_1.SelectorType.Descendant||(i(),a.push({type:types_1.SelectorType.Descendant})),n(1);break;case 62:p(types_1.SelectorType.Child),n(1);break;case 60:p(types_1.SelectorType.Parent),n(1);break;case 126:p(types_1.SelectorType.Sibling),n(1);break;case 43:p(types_1.SelectorType.Adjacent),n(1);break;case 46:l("class",types_1.AttributeAction.Element);break;case 35:l("id",types_1.AttributeAction.Equals);break;case 91:n(1);var d=void 0,y=null;124===t.charCodeAt(r)?d=s(1):t.startsWith("*|",r)?(y="*",d=s(2)):(d=s(0),124===t.charCodeAt(r)&&61!==t.charCodeAt(r+1)&&(y=d,d=s(1))),n(0);var A=types_1.AttributeAction.Exists,f=actionTypes.get(t.charCodeAt(r));if(f){if(A=f,61!==t.charCodeAt(r+1))throw new Error("Expected `=`");n(2)}else 61===t.charCodeAt(r)&&(A=types_1.AttributeAction.Equals,n(1));var C="",S=null;if("exists"!==A){if(isQuote(t.charCodeAt(r))){for(var v=t.charCodeAt(r),b=r+1;b<t.length&&(t.charCodeAt(b)!==v||c(b));)b+=1;if(t.charCodeAt(b)!==v)throw new Error("Attribute value didn't end");C=unescapeCSS(t.slice(r+1,b)),r=b+1}else{for(var _=r;r<t.length&&(!isWhitespace(t.charCodeAt(r))&&93!==t.charCodeAt(r)||c(r));)r+=1;C=unescapeCSS(t.slice(_,r))}n(0);var m=32|t.charCodeAt(r);115===m?(S=!1,n(1)):105===m&&(S=!0,n(1))}if(93!==t.charCodeAt(r))throw new Error("Attribute selector didn't terminate");r+=1;var w={type:types_1.SelectorType.Attribute,name:d,action:A,value:C,namespace:y,ignoreCase:S};a.push(w);break;case 58:if(58===t.charCodeAt(r+1)){a.push({type:types_1.SelectorType.PseudoElement,name:s(2).toLowerCase(),data:40===t.charCodeAt(r)?o():null});continue}var g=s(1).toLowerCase(),T=null;if(40===t.charCodeAt(r))if(unpackPseudos.has(g)){if(isQuote(t.charCodeAt(r+1)))throw new Error("Pseudo-selector ".concat(g," cannot be quoted"));if(r=parseSelector(T=[],t,r+1),41!==t.charCodeAt(r))throw new Error("Missing closing parenthesis in :".concat(g," (").concat(t,")"));r+=1}else{if(T=o(),stripQuotesFromPseudos.has(g)){var E=T.charCodeAt(0);E===T.charCodeAt(T.length-1)&&isQuote(E)&&(T=T.slice(1,-1))}T=unescapeCSS(T)}a.push({type:types_1.SelectorType.Pseudo,name:g,data:T});break;case 44:u(),a=[],n(1);break;default:if(t.startsWith("/*",r)){var k=t.indexOf("*/",r+2);if(k<0)throw new Error("Comment was not terminated");r=k+2,0===a.length&&n(0);break}y=null;var x=void 0;if(42===h)r+=1,x="*";else if(124===h){if(x="",124===t.charCodeAt(r+1)){p(types_1.SelectorType.ColumnCombinator),n(2);break}}else{if(!reName.test(t.slice(r)))break e;x=s(0)}124===t.charCodeAt(r)&&124!==t.charCodeAt(r+1)&&(y=x,42===t.charCodeAt(r+1)?(x="*",r+=2):x=s(1)),a.push("*"===x?{type:types_1.SelectorType.Universal,namespace:y}:{type:types_1.SelectorType.Tag,name:x,namespace:y})}}return u(),r}exports.parse=parse;
